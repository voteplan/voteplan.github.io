<!DOCTYPE html>

<html>
    <head>

        <script
            src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.6.1/Sortable.min.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Open+Sans:600" rel="stylesheet">

        <style>
* {
    font-family: 'Open Sans', sans-serif;
    color: #111;
}

body {
    background-color: #f3f3eb;
    text-align: center;
}

h1 {
    margin-top: 20px;
    margin-bottom: 0;
    margin-left: 40px;
    font-size: 19px;
}

h2 {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 40px;
    font-size: 24px;
    margin-bottom: 10px;
}

h3 {
    margin: 0;
	margin-top: 20px;
}

ol#items {
    display: inline-block;
    margin-bottom: 30px;
    margin-right: auto;
    margin-left: auto;
}

ol#items li {
    text-align: left;
    padding: 4px 8px;
    border: 1px solid #bbb;
    cursor: move;
    cursor: grab;
    background-color: #fff;
    min-width: 480px;
    white-space: nowrap;
}

.toggle {
    background-color: #ddd !important;;
}

.toggle-span:before {
    content: "✔ ";
}

.ghost {
    background-color: #888 !important;
    position: relative;
}

.hovering {
    background-color: #bbb !important;
}

.instructions {
    width: 400px;
    margin: 0 auto;
    text-align: left;
}

.instructions-list {
    margin-top: 10px;
}

input {
    width: 270px;
    margin-left: 30px;
    float: right;
}

#url {
	display: inline-block;
	background-color: #fff;
	user-select: all;
	margin: 0;
	word-break: break-all;
	width: 500px;
	border: 1px solid #bbb;
}

#names-textarea {
	font-size: 16px;
}

.links {
    width: 400px;
    margin: 0 auto;
    text-align: left;
}

.link-list {
	margin-top: 10px;
}

ol.subsetList li {
    text-align: left;
    width: 470px;
}

ol.subsetList {
    display: inline-block;
}

#subsetDiv {
	margin-bottom: 30px;
}

h3#subsetDiv {
	margin: 0 !important;
}

.exampleSpan {
	background-color: #fff;
}

p {
	max-width: 800px;
	margin: 20px auto;
}

* {
    font-family: 'Open Sans', sans-serif;
    color: #111;
}

body {
    background-color: hsl(28, 18%, 92%);
    text-align: center;
}

h1 {
	margin: 10px 20px;
    font-size: 19px;
}

h2 {
	margin: 10px 20px;
    font-size: 24px;
    margin-bottom: 10px;
}

h3 {
	margin: 0;
}

ol#items {
    display: inline-block;
    margin-bottom: 10px;
    margin-right: auto;
    margin-left: auto;
}

ol#items li {
    text-align: left;
    padding: 4px 8px;
    border: 1px solid hsl(28, 10%, 82%);
    cursor: move;
    cursor: grab;
    background-color: #fff;
    width: 500px;
	white-space: nowrap;
}

.toggle {
    background-color: hsl(28, 10%, 75%) !important;
}

.toggle-span:before {
    content: "✔ ";
}

.ghost {
    background-color: hsl(28, 7%, 60%) !important;
    position: relative;
}

.hovering {
    background-color: hsl(28, 10%, 82%) !important;
}

.instructions {
    width: 500px;
    margin: 0 auto;
    text-align: left;
	margin-top: 20px;
}

.instructions-list {
	margin-top: 10px;
}

.instructions-list li {
	margin: 15px 0;
}

input {
    width: 270px;
    margin-left: 10px;
    float: right;
    border: 1px solid hsl(28, 10%, 70%);
}

ol#subsetList li {
    text-align: left;
    width: 500px;
}


ol#subsetList {
    display: inline-block;
}

.listDiv {
	margin: 15px auto;
	width: 500px;
	background-color: #fff;
	border-radius: 10px;
	border: 1px solid hsl(28, 10%, 82%);
}

.listContainerDiv {
	padding: 20px;
}

#headingDiv {
    background-color: hsl(28, 10%, 82%);
	display: table;
	margin: 0 auto;
	margin-top: 20px;
	border-radius: 10px;
}
        </style>

        <title>VotePlan</title>
    </head>

    <body>
        <div id="content"></div>

        <script>

var questionMarkIndex = window.location.href.indexOf('?');

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return results[2].replace(/\+/g, ' ');
}

var rawNamesString = getParameterByName('names');
var edit = getParameterByName('edit') == 'true';

if ((questionMarkIndex < 0 || !rawNamesString) && !edit) {
	$('#content').html(		
		'<div id="headingDiv">'+
		'<h2 id="subheading">VotePlan</h2>'+
		'</div>'+
        '<h1>Hobart City Council Election 2018</h1>'+
        '<div class="links">'+
        '    <ul class="link-list">'+
        '        <li><a href="hobart-city-council-2018-councillors">Councillors</a></li>'+
        '        <li><a href="hobart-city-council-2018-lord-mayor">Lord Mayor</a></li>'+
        '        <li><a href="hobart-city-council-2018-deputy-lord-mayor">Deputy Lord Mayor</a></li>'+
		'	</ul>'+
        '</div>'+
		'<p><a href="https://voteplan.github.io/?edit=true">Make your own list</a></p>'+
		'<p>Send feedback to <a href="mailto:programming4politics@protonmail.com">programming4politics@protonmail.com</a></p>'
	);

} else if (edit) {
    $('#content').html(
		'<div id="headingDiv">'+
		'<h2 id="subheading">VotePlan</h2>'+
		'</div>'+
		'<p>Please note that this is still being developed. If problems arise, please send an email to <a href="mailto:programming4politics@protonmail.com">programming4politics@protonmail.com</a></p>'+
		'<h3><a href="https://voteplan.github.io/?names=BLAKE,+Ann;BOWEN,+Mathew;BRADY,+Thane;Deputy+Mayor!COOPER,+Leon;COX,+Jim;DAKING,+Nick;Deputy+Mayor!DAWKINS,+Andrea;Mayor!FINLAY,+Janie;Mayor!FITCH,+Basil;Deputy+Mayor!GIBSON,+Danny;GROAT,+Daniel;Mayor!HARRIS,+Alan;LIMB,+Ryan;McKENDRICK,+Robin;Deputy+Mayor!McKENZIE,+Hugh;MADDEN,+Gary;POTTER,+Bruce;PREECE,+Krista;ROE,+Brian;Mayor!SALT,+Bob;SANDS,+Ted;Mayor!SHERRIN,+Joshua;Deputy+Mayor!SOWARD,+Rob;SPENCER,+Paul;SPRINGER,+Damien;Deputy+Mayor!STOJANSEK,+Karina;Mayor!SWEENEY,+Tegan;TAPSELL,+Mark;Mayor!VAN+ZETTEN,+Albert;Mayor!WALKER,+Tim;Deputy+Mayor!WILLIAMS,+Emma;Deputy+Mayor!WOOD,+Simon">Click here for an example list</a></h3>'+
		'<br>'+
		'<h3>Step 1</h3>'+
        '<p>Put names in the text area below, each name on its own line.</p>'+
		'<p>To add a name to a subset (like the "Mayor" and "Deputy Mayor" subsets in the example)<br>put the subset name and a ! (exclamation mark) before the name.<br>Example: <span class="exampleSpan">Deputy Mayor!LASTNAME, Firstname</span></p>'+
		'<textarea id="names-textarea" rows=20 cols=40 oninput=\'this.style.height = "";this.style.height = this.scrollHeight + "px"\'></textarea>'+
		'<h3>Step 2</h3>'+
		'<p>Copy and share the URL below. You may want to use a URL shortener.</p>'+
        '<p id="url">https://voteplan.github.io/?</p>'
    );
    $('#names-textarea').on('change keyup paste', function() {
        $('#url').text(
			'https://voteplan.github.io/?names='+
			this.value
			.trim()
			.replace(/ {2,}/g, ' ')
			.replace(/\n{2,}/g, '\n')
			.replace(/<>;/g, '')
			.replace(/\n/g, ';')
			.replace(/ /g, '+')
		);
    });

} else {
    $('#content').html(
		'<div id="headingDiv">'+
		'<h2 id="subheading">VotePlan</h2>'+
		'</div>'+
        '<div class="instructions">'+
        '    <ul class="instructions-list">'+
        '        <li>Drag names to order them.</li>'+
        '        <li>Click names to toggle tick.</li>'+
        '        <li>Use the text boxes to add notes.</li>'+
        '    </ul>'+
        '    <p>Send feedback to <a href="mailto:programming4politics@protonmail.com">programming4politics@protonmail.com</a></p>'+
        '</div>'+
        '<ol id="items"></ol>'
    )

	var names = [];
	var subsets = {};
	
	var rawNames = rawNamesString.split(';');

	$.each(rawNames, function(i) {
		var matches = rawNames[i].match(/([^\\!]+)([^\\!]+)/g);
		var name = matches.pop().trim();

		for (var i = 0; i < matches.length; i++) {
			var subsetName = matches[i].trim();
			(subsets[subsetName] = subsets[subsetName] || []).push(name);
		}

		names.push(name);
	});

    var items = $('#items')
    $.each(names, function(i) {
        var li = $('<li/>')
            .appendTo(items);
        var input = $('<input/>')
            .addClass('notes')
            .attr('placeholder', 'Notes')
            .appendTo(li);
        var span = $('<span/>')
            .addClass('name')
            .text(names[i])
            .appendTo(li);
    });

    var canHover = true;

	var el = document.getElementById('items');
    var sortable = Sortable.create(el, {
        ghostClass: 'ghost',
        onEnd: function (evt) {
            canHover = true;
			generateLists();
        },
        onChoose: function (evt) {
            canHover = false;
            $('ol#items li').removeClass('hovering');
        },
    });

    $('ol#items li').on('click', function(e){
        if (!$(e.target).hasClass('notes')) {
            $(this).toggleClass('toggle');
            $(this).children('span').first().toggleClass('toggle-span');
        }
        canHover = true;
    });

    $('.notes').focus(function(){
        canHover = true;
    });

    $('ol#items li').bind('mouseenter', function(){
        if (canHover) {
            $(this).addClass('hovering');
        }
    }).bind('mouseleave', function(){
        $(this).removeClass('hovering');
    });

    document.documentElement.addEventListener('mouseup', function(e){
        canHover = true;
    });

	$('<div/>').attr('id', 'subsetDiv').appendTo('#content');

	function generateLists() {
		var subsetDiv = $('<div/>').attr('id', 'subsetDiv');
		
		$('<h3/>')
			.text('In alphabetical order')
			.appendTo(subsetDiv);

		var alphabeticalNamesList = $('<ol/>').addClass('subsetList');
		
		var alphabeticalNames = [];
		
		$('ol#items li').each(function(i) {
			alphabeticalNames.push({
				"name": $(this).text(),
				"value": i + 1
			})				
		});
		
		alphabeticalNames.sort(function (a, b) {
			return a.name.localeCompare(b.name);
		});
		
		for (var i = 0; i < alphabeticalNames.length; i++) {
			$('<li/>')
				.text(alphabeticalNames[i].name)
				.attr('value', alphabeticalNames[i].value)
				.appendTo(alphabeticalNamesList);
		}
		
		alphabeticalNamesList.appendTo(subsetDiv);		

		for (key in subsets) {
			if (subsets.hasOwnProperty(key)) {
				$('<h3/>')
					.text(key+' (in the order above)')
					.appendTo(subsetDiv);
				var subsetList = $('<ol/>').addClass('subsetList');

				$('ol#items li').each(function() {
					if (subsets[key].includes($(this).text())) {
						$('<li/>')
							.text($(this).text())
							.appendTo(subsetList);
					}
				});
				subsetList.appendTo(subsetDiv);
			}
		}
		subsetDiv.appendTo('#content')

		$('#subsetDiv').replaceWith(subsetDiv);
	}

	generateLists();
}
        </script>
        <body>
</html>
